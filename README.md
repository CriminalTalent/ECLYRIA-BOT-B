# ⚔️ Battle Bot - README

마스토돈 기반의 1:1 / 2:2 전투 시스템과  
행운 기반 조사 시스템을 제공하는 **RP 유틸 봇**입니다.  
Google Sheets를 상태 저장소로 사용하며,  
실시간 멘션 기반으로 캐릭터의 행동을 처리합니다.

---

## 🚀 주요 기능

### ⚔️ 전투 시스템

| 명령어 | 기능 설명 |
|--------|-----------|
| `[전투개시/@우리팀/@상대방1/@상대방2]` | 2:2 팀 전투 시작 |
| `[허수아비 상/중/하]` | 혼자서 AI 허수아비와 전투 연습 |
| `[공격]` | 전투 중 공격 (공격력 + D20 vs 방어력 + D20) |
| `[방어]` | 방어 자세, 턴 넘기기 |
| `[반격]` | 상대방에게 반격 (공격력 + D20 vs 방어력 + D20) |
| `[도주]` | 전투 탈출 시도 (행운 + 민첩 + D20 vs 상대 민첩 + D20) |
| `[물약사용]` | 체력 랜덤 회복 (5/10/15/20), 아이템 차감 |

**전투 특징:**
- 민첩 기반 선후공 결정
- D20 + 스탯 기반 턴제 전투
- 체력 0 도달 시 전투 종료
- 실시간 상태 업데이트
- **이중 알림**: 공개 타임라인 + 참가자 DM 동시 발송
- **허수아비 AI**: 난이도별 다른 행동 패턴
- **2:2 팀 전투**: 4명이 함께하는 팀 배틀
- **자동 턴 넘김**: 5분 무응답 시 자동으로 다음 턴

### 🤖 허수아비 시스템

| 난이도 | 체력 | 공격력 | 방어력 | 민첩 | AI 패턴 |
|--------|------|--------|--------|------|---------|
| **하** | 60 | 8 | 6 | 8 | 70% 공격, 20% 방어, 10% 물약 |
| **중** | 80 | 12 | 10 | 12 | 60% 공격, 25% 방어, 10% 반격, 5% 물약 |
| **상** | 100 | 16 | 14 | 16 | 50% 공격, 20% 방어, 25% 반격, 5% 물약 |

**허수아비 특징:**
- 혼자서도 전투 연습 가능
- 자동 AI 턴 진행 (2초 딜레이)
- 난이도별 차별화된 전략

### 🕵️ 조사 시스템

| 명령어 | 기능 설명 |
|--------|-----------|
| `[조사] [대상명]` | 기본 조사 (행운 + D20 vs 난이도) |
| `[정밀조사] [대상명]` | 정밀한 조사 |
| `[감지] [대상명]` | 감지 능력 사용 |
| `[훔쳐보기] [대상명]` | 은밀한 관찰 |
| `DM조사결과 @유저 결과내용` | DM이 조사 결과 직접 전송 |

**조사 특징:**
- 하루 1회 제한 (`마지막조사일` 기준)
- 행운 스탯 + D20 판정
- 성공/실패에 따른 다른 결과
- `조사` 시 `DM조사` 항목도 자동 검색
- DM이 수동으로 결과 전송 가능

---

## 📄 Google Sheets 구조

### ✅ 사용자 시트 ("사용자")

| 열 | 필드명 | 설명 |
|----|--------|------|
| A | ID | 마스토돈 계정 (@user@server) |
| B | 이름 | 캐릭터명 또는 닉네임 |
| C | 체력 | 현재 HP (기본 100) |
| D | 공격력 | 공격 시 사용 |
| E | 마력 | 마법 관련 능력 |
| F | 방어력 | 방어 시 사용 |
| G | 민첩 | 선후공 및 도주 판정 |
| H | 행운 | 조사 판정 보정값 |
| I | 아이템 | 소지 아이템 목록 |
| J | 마지막조사일 | 조사 제한 확인용 (YYYY-MM-DD) |

### ✅ 조사 시트 ("조사")

| 열 | 필드명 | 설명 |
|----|--------|------|
| A | 대상 | 조사할 대상명 |
| B | 종류 | `조사`, `정밀조사`, `감지`, `훔쳐보기`, `DM조사` |
| C | 난이도 | 성공 기준값 (정수) |
| D | 성공결과 | 판정 성공 시 결과 메시지 |
| E | 실패결과 | 판정 실패 시 결과 메시지 |

**조사 종류 설명:**
- `조사`: 일반적인 조사, `DM조사` 항목도 함께 검색
- `DM조사`: DM 전용 항목, 일반 `조사`에서도 매칭됨

---

## 💬 사용 명령어 예시

### ⚔️ 전투 명령

```bash
# 2:2 팀 전투 시작 (명령어 입력자 + 우리팀 vs 상대팀 2명)
@battle [전투개시/@우리팀/@상대방1/@상대방2]

# 허수아비 연습 전투 (혼자서 가능)
@battle [허수아비 하]
@battle [허수아비 중]  
@battle [허수아비 상]

# 전투 중 행동
@battle [공격]
@battle [방어]  
@battle [반격]
@battle [도주]
@battle [물약사용]
```

**📢 전투 결과 알림:**
- 🌍 **공개 타임라인**: 모든 사람이 전투 상황 구경 가능
- 📱 **참가자 DM**: 전투 참가자들에게 개별 DM 발송 (허수아비 제외)
- 모든 전투가 동일한 이중 알림 시스템 적용

### 🕵️ 조사 명령

```bash
# 기본 조사
@battle [조사] [마법의 문]
@battle [정밀조사] [고대 유물]
@battle [감지] [숨겨진 통로]
@battle [훔쳐보기] [비밀 회의]

# DM 조사 결과 전송
@battle DM조사결과 @유저 "당신은 숨겨진 보물을 발견했습니다."
```

---

## 🛠 설치 및 실행

### 1. 의존성 설치
```bash
bundle install
```

### 2. 환경변수 설정 (.env)
```env
MASTODON_BASE_URL=https://eclyria.pics
MASTODON_TOKEN=당신의_전투봇_토큰
GOOGLE_SHEET_ID=스프레드시트_ID
GOOGLE_CREDENTIALS_PATH=credentials.json
TZ=Asia/Seoul
```

### 3. Google 서비스 계정 설정
1. Google Cloud Console에서 서비스 계정 생성
2. JSON 키를 다운로드 → `credentials.json`로 저장
3. Google Sheets의 공유 설정에서 서비스 계정 이메일을 "편집자"로 추가

### 4. 실행
```bash
ruby main.rb
```

---

## 📁 프로젝트 구조

```
battle_bot/
├── main.rb                     # 실행 진입점
├── mastodon_client.rb          # 마스토돈 API 래퍼
├── sheet_manager.rb            # Google Sheets 핸들러
├── command_parser.rb           # 전투봇 커맨드 파서
├── commands/                   # 명령어별 핸들러
│   ├── battle_command.rb       # 전투 관련 명령어
│   ├── investigate_command.rb  # 조사 명령어
│   ├── potion_command.rb       # 물약 사용
│   └── dm_investigation_command.rb # DM 조사 결과
├── core/                       # 핵심 시스템
│   ├── battle_engine.rb        # 전투 로직 엔진
│   └── battle_state.rb         # 전투 상태 관리
├── .env                        # 환경변수
├── credentials.json            # Google API 인증 (gitignore)
└── Gemfile                     # Ruby 의존성
```

---

## 🎯 전투 시스템 세부사항

### 선후공 결정
- 각 플레이어의 `민첩` + D20 계산
- 높은 쪽이 선공

### 공격 판정
```
공격자: 공격력 + D20
방어자: 방어력 + D20
데미지 = max(공격값 - 방어값, 0)
```

### 도주 판정
```
도주자: 행운 + 민첩 + D20
추격자: 민첩 + D20
성공 시 전투 종료
```

### 물약 효과
- 랜덤 회복량: 5, 10, 15, 20 중 하나
- 최대 체력: 100
- 아이템에서 포션 1개 차감

---

## 🕵️ 조사 시스템 세부사항

### 판정 공식
```
판정값 = 행운 + D20
성공 조건: 판정값 ≥ 난이도
```

### 제한사항
- 하루 1회 제한 (자정 기준 리셋)
- 모든 조사 종류 통합 제한

### DM 기능
- `DM조사결과` 명령으로 직접 결과 전송
- 조사 날짜 자동 업데이트
- DM 전용으로 결과 발송

---

## 🔧 개발 도구

- **Ruby 3.0.2**
- **Mastodon API** (mastodon-api gem)
- **Google Sheets API v4** (google-apis-sheets_v4)
- **환경변수 관리** (dotenv)

---

## 📝 추가 설정 추천

### .gitignore
```gitignore
.env
credentials.json
config.json
*.log
```

### 시스템 요구사항
- Ruby 3.0+
- 인터넷 연결 (마스토돈, 구글 시트 API)
- Google Cloud Platform 계정

---

## 🚨 주의사항

1. **동시 전투 제한**: 한 번에 하나의 전투만 가능
2. **시트 권한**: 봇 서비스 계정에 편집 권한 필요
3. **API 제한**: 마스토돈/구글 API 사용량 제한 고려
4. **데이터 백업**: 시트 데이터 정기 백업 권장
5. **2:2 전투**: 총 4명의 참가자 필요
6. **알림 시스템**: 모든 전투 참가자에게 DM 발송됨
7. **턴 타임아웃**: 5분 무응답 시 자동으로 턴 넘어감
8. **인터넷 연결**: 접속 불안정 시 타임아웃 가능성

---

## 🎮 게임 팁

### 전투 전략
- 높은 민첩으로 선공 확보
- 방어와 공격의 균형 유지
- 위기 상황에서 도주 고려
- **신속한 판단**: 5분 내에 행동 결정하기

### 시간 관리 팁
- **빠른 결정**: 5분은 충분하지만 신중하게
- **팀 전투 시**: 팀원과 미리 전략 상의
- **타임아웃 활용**: 상대방이 고민 중일 때 기다리기
- **DM 확인**: 놓친 전투 알림을 DM에서 확인

### 다대다 전투 전략
- **1 vs 2 전투**: 체력과 물약 관리가 핵심
- 상대가 많을수록 도주 성공률 고려
- 선공 확보가 더욱 중요함

### 🤖 허수아비 활용법
- **허수아비 하**: 전투 시스템 익히기, 초보자 연습
- **허수아비 중**: 반격 패턴 경험, 중급자 연습
- **허수아비 상**: 고난이도 전투 연습, 고수 도전
- 실제 PvP 전에 허수아비로 전략 테스트

### 📢 알림 활용
- **공개 타임라인**: 다른 전투 구경하며 전략 학습
- **개인 DM**: 놓친 전투 결과 확인 가능
- 전투 중 멘션 놓쳐도 DM으로 결과 확인

### 조사 팁
- 행운 스탯 투자로 성공률 증가
- 하루 1회 제한이므로 신중하게 선택
- DM과 협력하여 스토리 진행

### 스탯 관리
- 전투형: 공격력, 방어력, 민첩 중심
- 조사형: 행운, 민첩 중심
- 밸런스형: 모든 스탯 적절히 분배
- 다대다 전투용: 민첩과 체력 우선 고려
